import { useState, useRef, useEffect } from 'react';
import './AsciiVisual.css';
import { useMechanicalClick } from '../hooks/useMechanicalClick';

const ORIGINAL_ASCII = `
                                             :::::::::::::::::::::                                                                                   
                                      ::::::::::::::::::::::::::::::                                                                                 
                              ::::::::::::::::::::::::::::::::::::::::::::                                                                           
                                :::::::::::::::::::::::::::    :::::::::::::                                                                         
                                       ::::::::::::::::::::::::::::::::::::::                                                                        
                                     :::::::::::::::::::::::::::::::::::::::::                                                                       
                                   ::::::::::::::::::::::::::::::::::::  ::::                                                                        
                                 ::::::::::::::::::::::::::::::::::        ::                                                                        
                                :::::::::::::::::::::::::::::::::                                                                                    
                               ::::::::::::::::::::::::::::::::::                                                                                    
                              :::::::::::::::::::::::::::::::::::                                                                                    
                             :::::::::::::::::::::::::::::::::::::                                                                                   
                            :::::::::::::::::::::::::::::::::::::::                                                                                  
                               :::::::::::::::::::::::::::::::::::::                                                                                 
                              :::::::::::::::::::::::::::::::::::::::                                                                                
                             :::::::::::::::::::::::::::::::::::::::::                                                                               
                            ::::::::::::::::::::::::::::::::::::::::::::                                                                             
                           :::::::::::::::::::::::::::::::::::::::::::::::                                                                           
                          ::::::::::::::::::::::::::::::::::::::::::::::::::                                                                         
                          ::::::::::::::::::::::::::::::::::::::::::::      ::                                                                       
                         :::::::::::::::::::::::::::::::::::::::::::::::                                            ::                               
                        :::: ::::::::::::::::::::::::::::::::::::::::::::                                          :::                               
                            :::::::::::::::::::::::::::::::::::::::::::::::                                      ::::::                              
                           :::::::::::::::::::::::::::::::::::::::::::::::::                                  :::::::::                              
                           :::::::::::::::::::::::::::::::::::::::::::::::::::                              :::::::::::                              
                           ::::::::::::::::::::::::::::::::::::::::::::::::::::                           :::::::::::::                              
                          :::::::::::::::::::::::::::::::::::::::::::::::::::::::                       :::::::::::::::                              
                          ::::::::::::::::::::::::::::::::::::::::::::::::::::::::                     ::::::::::::::::                              
                          ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::                  :::::::::::::::::                              
                          :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::                ::::::::::::::::::                              
                           ::: ::::::::::::::::::::::::::::::::::::::::::::::::::::::::              :::::::::::::::::                               
                           ::  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::             ::::::::::::::::                                
                               :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::           ::::::::::::::                                  
                               :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::         :::::::::::::                                   
                                :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::         :::::::::::                                    
                                 ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::       :::::::::::                                    
                                  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::       ::::::::::                                    
                                   :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::      :::::::::                                    
                                    :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::       ::::::::                                   
                                      ::::::::::::::::::::::::::::::::::::::::::::::    :::::::::::::      ::::::::                                  
                                        ::::::::::::::::::::::::::::::::::::::::::    ::::::::::::::::      ::::::::                                 
                                           ::::::::::::::::::::::::::::::::::::::    :::::::::::::::::::     ::::::::                                
                                              ::::::::::::::::::::::  ::::::::::    :::::::::::::::::::::     :::::::::                              
                                                 ::::::::::::::::::       ::::::   :::::::::::::::::::::::     :::::::::                             
                                            ::     ::::::::::::::::          ::   :::::::::::::::::::::::::     :::::::::                            
                                            :::::     :::::::::::::   :::::       ::::::::::::::::::::::::::     :::::::::                           
                                            ::::::::   :::::::::::   :::::::::    :::::::::::::::::::::::::::     :::::::::                          
                                            ::::::::::::::::::::::   ::::::::::   :::::::::::::::::::::::::::      :::::::::                         
                                            :::::::::::::::::::::    :::::::::::   :::::::::::::::::::::::::::      :::::::::                        
                                            :::::::::::::::::::::   ::::::::::::    ::::::::::::::::::::::::::      :::::::::                        
                                            :::::::::::::::::::::   :::::::::::::    :::::::::::::::::::::::::      :::::::::                        
                                            ::::::::: ::::::::::      ::::::::::::    ::::::::::::::::::::::::      :::::::::                        
                                            ::::::::: ::::::::::       ::::::::::::     :::::::::::::::::::::::    ::::::::::                        
                                            :::::::::  :::::::::         :::::::::::      ::::::::::::::::::::: :::::::::::::                        
                                            ::::::::   ::::::::           ::::::::::         :::::::::::::::::::::::::::::::                         
                                            ::::::::   ::::::::            ::::::::::           :::::::::::::::::::::::::::                          
                                            ::::::::   :::::::            ::::::::::              :::::::::::::::::::::::                            
                                             :::::::   :::::::          ::::::::::                   :::::::::::::::::                               
                                     :::::::::::::::::::::::::   :::::::::::::::       ::::::::::::::::::::::::                                      
                                    :::::::::::::::::::::::::   :::::::::::::        :::::::::::::::::::::::::                                       
                                    :::::::::::::::::::::::::   :::::::::::::         :::::::::::::::::::::::::                                      
`;

// "Cellular" density characters
const CELL_CHARS = '.:+*#@';

const AsciiVisual = ({ onClick }: { onClick?: () => void }) => {
    const [displayText, setDisplayText] = useState(ORIGINAL_ASCII);
    const [isActive, setIsActive] = useState(false);
    const animationRef = useRef<number | null>(null);
    const { playClick } = useMechanicalClick();

    const performGlitch = () => {
        if (isActive) return;
        setIsActive(true);

        // No start time needed for infinite loop
        // Infinite loop, so no DURATION check needed.

        // Throttle for "organic" feel
        let lastUpdate = 0;
        const UPDATE_INTERVAL = 60;

        const animate = (currentTime: number) => {
            // Just keep animating forever until component unmounts or page refreshes

            if (currentTime - lastUpdate > UPDATE_INTERVAL) {
                setDisplayText(ORIGINAL_ASCII.split('\n').map(line => {
                    return line.split('').map(char => {
                        // STRICTLY confinement to shape:
                        if (char === ' ') return ' ';

                        // Mutate existing cells based on chance
                        // High chance to change, giving "boiling" liquid feel
                        if (Math.random() < 0.3) {
                            return CELL_CHARS[Math.floor(Math.random() * CELL_CHARS.length)];
                        }

                        // Occasional decay to nothing (holes)
                        if (Math.random() < 0.1) {
                            return ' ';
                        }

                        return char;
                    }).join('');
                }).join('\n'));
                lastUpdate = currentTime;
            }

            animationRef.current = requestAnimationFrame(animate);
        };

        animationRef.current = requestAnimationFrame(animate);
    };

    useEffect(() => {
        return () => {
            if (animationRef.current) cancelAnimationFrame(animationRef.current);
        };
    }, []);

    const handleClick = () => {
        playClick();
        performGlitch();
        onClick?.();
    };

    return (
        <div
            className={`ascii-visual ${isActive ? 'active' : ''}`}
            style={{ pointerEvents: onClick ? 'auto' : 'none' }}
            onClick={handleClick}
            title="START MENACING."
        >
            <div className="ascii-content">
                {displayText}
            </div>
        </div>
    );
};

export default AsciiVisual;
